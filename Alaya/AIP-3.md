---
AIP:  3
Topic: 提议对零出块处罚机制做优化
Author: alliswell
Status: Final 
Type: Requirement
Discussions-to: https://forum.latticex.foundation/t/topic/1210/20
Description: 关于节点错过出块期被处罚场景的优化
Created: 2020-03-30
---

# AIP-3：处罚策略优化-节点零出块处罚措施改进

## 背景

PoS类共识协议中，处罚是防止节点作恶，维护系统安全的必要手段。Alaya的PPoS协议中，针对零出块的节点进行处罚主要防止没有物理设备的虚假节点、恶意节点、不在线节点、配置太低的节点被选为验证节点后不生产和验证区块，直接影响整个网络的性能和活性。

Alaya现有的PPoS协议中，零出块行为的判断规则为在某个共识周期中被当选为验证节点但是没有生产任何有效的区块，零出块的行为的处罚策略为强制节点解除质押，质押金将被锁定一定的结算周期。

近期根据测试网的部分节点反馈，节点由于升级操作时间稍长或网络抖动等原因导致不能及时出块，从而被处罚，而且多数节点认为Alaya当前的处罚策略过于严厉，不利于节点参与网络治理。实际上零出块处罚实际要考虑的是安全性和容错性的权衡，现在是偏向安全性，目前我们以判断不在线的规则的确可能太严格，可能会误伤诚实节点。

为加强Alaya网络的容错性，避免诚实节点轻易被处罚，综合各个节点的意见，提议对当前处罚策略做出调整优化。

## 目的

Alaya应充分听取采纳社区意见，让更多诚实节点能公平公正的参与到Alaya网络建设中来，解除节点由于非主观原因而被轻易处罚的顾虑。同时为了整体提升Alaya网络的健壮性和安全性，充分保障正常节点不会因为网络抖动、节点升级等因素受到处罚。另一方面，充分发挥Alaya治理机制的优越性，让更多节点一起充分参与和讨论，在合理性和安全性之间寻求一个平衡点。

## 内容

任何处罚措施都需要两个步骤：处罚行为判断和处罚执行措施。因此优化方向也可以从这两方面考虑：

- 放宽判断条件

  适当放宽零出块判断的条件，可以降低甚至消除短期升级或环境抖动的影响。比较直接的方案是根据更长的时间段的表现来判断，而不是根据短短几分钟的共识周期判断。但是恶意节点存在更长的无成本攻击时间，再考虑到虚假节点搭便车无成本获取更多收益的行为，这个时间段的长度应该不超过一个结算周期，因为质押成为节点并获得Staking收益需要一个结算周期的时间。

- 降低惩罚力度

  惩罚措施直接确定节点的成本，包括间接的收益损失和直接的质押金损失。这个成本也直接衡量了系统的安全性，也即是恶意节点的攻击成本。从安全性上看，惩罚力度越大越好。处罚措施可以分为三类：

  1）剥夺一段时间的被选取权

  对于节点来说，这种成本最低，只是一段时间的收益损失，另外一部分委托人基于利益的考虑也会更换委托节点，委托人的损失也是潜在的成本。对于诚实节点来说会是比较能接受的方案，操作上也比较方便。

  这个时间限制需要比强制解除质押的冻结时间短，否则跟强制解除质押没区别。所以这种方案实际上进一步降低了恶意节点的攻击成本，虚假节点搭便车的行为也不能得到很好的限制。

  2）扣除部分质押金

  本金的损失对节点来说有直接的成本感受，扣除多少也是需要仔细衡量的，需要在不影响诚实节点的参与积极性和有效处罚恶意节点中间做权衡。

  3）强制解除质押

  直接强制解除质押处罚措施，对于诚实节点来说要花相当长的时间才能重新参与到共识，特别是需要重新获得LAT持有者的委托。这个方案的成本在于间接的长时间不能参与共识导致的收益损失，但是从安全性角度来看是更好地增加了恶意节点的时间成本。

综合考虑，本次提案考虑以下方案：

1. 适当放宽判断条件，提高对诚实节点短期不稳定因素的容错性，适当降低诚实节点参与共识的成本，提高可操作性。
2. 保持强制解除质押的惩罚措施，以及扣除部分质押金（目前为0）。在第一个优化错误降低安全性的同时，作为平衡，保持更高的攻击成本。

### 现有的零出块处罚的处理逻辑

- 每个共识周期中每出一个区块，系统根据出块节点的ID记录该节点的出块数。
- 下一个共识轮的固定块高第230个区块开始执行前对上一个共识轮每个节点的出块数做统计。
- 判断处罚条件：出块数小于一定数值（目前数值为1），则直接对该节点进行处罚。
- 处罚方式为：a.扣除一定比例的质押金（目前比例为0%） b.强制解质押该节点。

### 提议调整处理逻辑

- 增加以下2个治理参数：
  1. 零出块最大容忍的共识周期数E，参数治理的范围为[N,43]，初始值为15
  2. 在最大容忍周期数内连续零出块的次数N，参数可治理范围为[1,E]，初始值为3

- 每一个共识轮的固定块高第230个区块开始执行前执行以下逻辑：
   1. 对上一个共识周期中每个验证人是否生产区块做判断。
   2. 如果有验证人节点未生产出块，则将节点行为记录或更新到一个观察列表中。
   3. 遍历观察列表中的每一个节点，当达到以下条件时对该节点进行处罚：
      A. 该验证节点首次出现零出块（即节点当选为验证人，并且在一个共识周期内没有出过块）到上一个共识周期数已经达到E。
	    B. 该节点在E内当选为验证人的次数超过N并且在E内没有出过任何一个区块。
   4. 观察列表的更新原则为：
      A. 只要节点在上一个共识周期生产过区块，直接将改节点移除观察列表。
	    B. 观察列表中每个节点对应一个在E内首次零出块所发生的共识周期数F和一个零出块发生的bit标识B（bit长度为E）。
	    C. 如果节点在上个共识周期没有当选为验证人，每次比特标识位左移一位，右补0，当选且没有出块，左移一位右补1。
	    节点没有当选：

	|    |    |    |    |    |    | F  |    |
	|:-- |:-- |:-- |:-- |:-- |:-- |:-- |:-- |
	|    |    |    |    |    |    |  1 |  0 |

	​        节点当选且零出块：

	|    |    |    |    |    |   |  F  |    |
	|:-- |:-- |:-- |:-- |:-- |:-- |:-- |:-- |
	|    |    |    |    |    |    |  1 |  1 |

	  D. 如果节点未达到处罚条件且首次零出块所发生的共识周期数对应的标识位被移出，如果右边没有为1的标识位，则将该节点从观察列表中清除，如果右边还有为1的标识，则更新F。
	  E. 判断是否需要处罚的条件

	|  F  |    |    |    |    |   |    |    |
	|:-- |:-- |:-- |:-- |:-- |:-- |:-- |:-- |
	|  1  | x | x  | x  | x  |  x |  x |  x |
	以上标识位，处罚条件为：B的最左bit为1并且x中1的个数大于（N-1）

