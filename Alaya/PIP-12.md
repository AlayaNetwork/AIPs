---
PIP:  12
Topic: Alaya网络优化升级提案
Author: alliswell
Status: Draft 
Type: Upgrade
Description: 关于节点分成比例的bug修复以及一些其他的优化
Created: 2020-11-26
---

# PIP-12：PlatON版本升级-0.14.0

## 目的

自Alaya上线以来获得了很多节点和用户的广泛关注，用户在使用Alaya网络的过程中也遇到了一些问题，本次升级的目的是为了修复这些问题。以下是近期收到用户反馈的部分问题：

- 修改分成比例失败问题

如果当前节点在下个结算周期未进入验证人列表（前101），则之前修改的分成比例没有机会生效，当该节点再次修改比例的时候，
修改幅度的判断是根据旧的已生效比例判断幅度，当新比例与已生效的比例差超过最高幅度时，将导致修改不成功。

- 用mtool修改节点信息，会导致分成比例被重新修改回旧值

通过mtool命令更新分红比例，如：70%->75%，命令执行成功后通过编辑节点信息命令更新了节点名称和描述，结果分红比例被改回70%

- 单次领取委托收益回执过大问题

当用户用同一个钱包委托多个节点时，如果节点数很多（如超过20个）将导致交易的回执过大，一方面client解析回执很慢，另一方面底层处理单笔交易的开销也将很大（耗时）

- 锁仓接口不限制最小锁仓金额，有被攻击的风险

当前锁仓合约虽然对单次锁仓期数做了限制，但对锁仓金额无限制，导致的问题是如果有人恶意锁仓，每个周期释放0.0000001的lat/atp，用极少的代币即可锁给超过1万人，如果攻击者设计在同一个结算周期释放所有锁仓（比如超过1万个）则特殊区块（锁仓释放逻辑）执行肯定会超时，导致底层处理不了。

- 用户领取委托收益和预期不符

在某些特殊场景下用户不能领取到本该属于自己的委托收益。

为加强Alaya网络的健壮性性，提升用户体验，综合各个节点的意见，提议升级Alaya网络。

## 新特性

无

## 优化功能

- keytool工具名改为platonkey或alayakey

## bug修复

### 修改分成比例失败问题

- 修改方案
在修改分成比例时，如果节点信息中下个周期的比例不为空且满足修改条件（时间间隔），则修改的值与下个周期比例做对比，符合就直接把下个周期比例修改为新值

- 影响
  1. 浏览器更换结算周期时自动更新当前比例和下周期的比例

  2. 如果查得到下个周期比例且和当前不同，浏览器就显示下个周期比例， 相同则不显示

  3. ATON显示和浏览器保持一致

### 单次领取委托收益回执过大问题

- 修改方案：
领取接口保持不变，但单次领取最多只能领取前N（比如20）个节点的收益，排名按最后一次领取委托收益发生的块高由小到大排序，超过N条委托关系需分多次领取

	> 说明：
	>  a. N值为固定常量，不支持治理
	>
	>  b. 当委托关系超过N时，前端（ATON）应提示用户只能领取部分委托奖励
	>
	>  c. 如果最近一次领取的块高相同， 则按ID顺序排，和查询接口排序规则一致


- 周边影响：
	1. ATON领取委托时提示用户

	2. 排查浏览器显示的结果是不是根据回执显示， 如果不是， 需要调整


### 锁仓接口可能会因为锁仓金额低导致锁仓数据量大，有被攻击的风险

- 修改方案：
  1. 对每个释放周期的释放金额做限制，比如不能少于Mlat/atp

  2. M值支持治理，初始值为PlatON：500 lat [500, 10000000] / Alaya：80 atp [80, 100000] 

- 周边影响：
  1. 锁仓工具限制单释放周期的锁定金额最小值

  2. 浏览器中增加每个释放周期的释放金额最小值M的治理

### 用户领取委托收益和预期不符

- 问题原因
  
  一些内置合约接口中会存在一些本应该是原子操作的数据读/写，但当前代码中未对数据库操作做原子性约束， 以本次发现的问题为例：
用户A使用锁仓金额进行委托，原流程如下：
  1. 触发lazy计算，将该节点待领取的收益计算后更新每个周期单位Token的收益P值的剩余领取次数（DB操作A)
  2. 验证锁仓金额是否满足委托使用的金额
  3. 如果金额足够，则更新委托信息包括最后领取收益的周期更新（DB操作B），如金额不足，返回错误信息

  问题出现在第3步，金额不足时， 没有将第1步更新的收益信息更新至委托信息中或将第1步的P值次数进行回滚

- 问题影响

  出现这种问题时由于第1步数据的P值剩余次数已经减掉了，但没有给A记账，导致同周期段的委托收益待领取次数少了一次，会使得最晚来领取收益的账户无法领取（收益将一直存在委托收益池合约）

- 修改方案

  所有内置合约的异常流程，需向最外层抛error，以便最外层根据error做数据回滚（以上面错误为例，第3步不继续更新领取的周期数，而是让第1步已经写入的数据回滚）需要对原回执中的status的值重新定义,涉及到浏览器、aton、sdk、测试用例等同时修改

### badblock问题

- 详细问题描述见[issues-1525](https://github.com/PlatONnetwork/PlatON-Go/issues/1525)

- 修改方案

  在storagevalue中加当前块高，影响到存储，需要改记账规则

### 用mtool修改节点信息，会导致分成比例被重新修改回旧值

- 详细问题描述见[issues-1602](https://github.com/PlatONnetwork/PlatON-Go/issues/1602)

- 修改方案

  将分成比例修改为非必填字段，这样mtool每次调用接口时如果用户没有指定修改分成比例底层将跳过

## 说明

  本次升级将兼容历史数据，需要链上治理升级。详见讨论[链接](https://forum.latticex.foundation/t/topic/4024)

## 版本信息

本次升级的版本号为：0.14.0

Commit-ID: 83c6dd6a20be631ef99bf4094e5eefeac559e7e2

