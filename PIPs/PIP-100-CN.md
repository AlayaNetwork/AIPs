---
PIP:  100
Topic: 调整令牌的增发周期|[English](./PIP-100.md)
Author: jianghaitao
Status: Draft
Type: Requirement
Description: 调整每年的结算周期数量，使年末增发令牌时间和现实预计增发时间趋于相同
Created: 2019-11-28
---

# PIP-100：令牌增发周期的动态调整

## Abstract

由于出块间隔时间不是确定，根据出块间隔确定令牌增发的周期会使实际的令牌增发周期出乎意料，
根据每年平均的出块速度可以动态调整增发周期所包含的结算周期个数。

## Motivation

校准令牌的增发周期

## Detail

### Requirement

区块头中的时间戳实际上是打包这个区块的矿工节点的机器时间, 
在'CbftConfig'配置中有2个参数，'Amount'和'Period', 'Amount'是一个节点在一个周
期内最多可以出的区块的数量，'Period'是周期的时长，单位是毫秒.

有了这2个参数，是否意味着平均出块的时间间隔是'Period'/'Amount'? 
要是这样理解就错了。

因为每个挖矿的节点都需要争取挖矿收益的最大化, 也就是说，他们都会尽量出满'Amount'
个区块（这样才能获取所有出块奖励），在交易池为空的情况下，矿工节点在有限的时间
'Period'内为了收益达到最大， 通常会提前出满'Amount'个区块，因为一旦后面的区块在
时间将要截止的时候生产出来，那么这个区块能够被确认的概率会低一些。

如果令牌增发按照出块间隔'Period'/'Amount'计算，由于实际间隔和计算结果可能存在
偏差很大的情况，实际令牌增发时间会变得不可预测，可能半年时间就增发一次， 也有
可能要过2年才会增发一次，因此，在链上根据平均出块间隔调整令牌增发的区块高度变
得十分必要。

本次升级主要是根据平均出块间隔动态调整令牌的增发周期，以使令牌实际增发周期和
我们设计的预期相符。与之相应的，由于每个增发周期内的结算周期数量不确定，而出
块和Staking的奖励是固定的，所以每个结算周期内的出块及Staking奖励需要根据当前
增发周期剩余的总奖励数动态计算。

### Implement

#### 增发时间间隔的理论值

由于区块链世界里没有绝对准确的时间，而PlatON经济模型中令牌增发是按照自然年固定
增发，因此需要一个增发时间间隔的理论值，自然年每隔4年有一个闰年，也就是说，平均
每年的固定时间约为:365+1/4天，转换为秒数为31557600秒。

#### 计算平均出块速度

我们以第一个区块的时间戳为第一年的起始时间，每个结算周期最后一个区块的时间戳计算此结算
周期向前一年时间内（以第一年经历的结算周期数为准）的平均出块间隔，则有：
N  : 第一年的结算周期数
Hn : 当前结算周期最后一个区块高度
Hl : Hn > N  ? Hn-N:1 （从Hn向前N个结算周期最后一个区块的高度，如果Hn大于N,Hl为Hn-N，否则Hl=1）
Tn : 当前结算周期最后区块的时间戳（毫秒）
Tl : Hl对应的时间戳
I  : 出块间隔

计算平均出块间隔：
I = Floor((Tn - Tl)/(Hn - Hl))

#### 计算本年度剩余的结算周期数

设：
n  : 当前结算周期所在的增发次数（创世区块内第一次增发）
Y  : 31557600000 毫秒（365+1/4天）
T0 : 第一个区块的时间戳（毫秒）
Tn : 当前结算周期最后区块的时间戳（毫秒）
C  : 10750 （每个结算周期的区块数）
L  : 当前增发周期剩余的结算周期数

则：
L = Ceiling(((T0 + n*Y) - Tn) / I*C)

#### 计算当前结算周期的出块奖励和质押奖励

设：
Ml : 当前结算周期开始时年度剩余令牌总数
V  : 结算周期结束块高对应的验证人总数
L  : 当前增发周期包含当前结算周期剩余的结算周期数
Rb : 出块固定奖励
Rs : 每个节点获得的质押奖励
R  : 奖励中分配给出块者的奖励比率（百分比）

有：
Rb = Ml * R / C*L
Rs = Ml * (1 - R) / (L * V) 

#### 基金会锁仓释放计划调整

PlatON基金会补贴矿工的计划会根据令牌实际增发次数，随令牌增发一起释放到激励池合约

#### 基金会令牌分配计划调整

PlatON平台规定系统在增发n次后将增发的指定比例的令牌分配给基金会，实际起始分配的时间根据增发次数和令牌增发一起分配

### Deployment

按正常步骤部署节点

## References
[PlatON经济模型蓝皮书](https://www.platon.network/static-new/pdf/en/PlatON_Blue_Paper_on_Economics_EN.pdf)
