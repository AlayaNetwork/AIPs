---
PIP:  3
Topic: 0.11.0版本升级
Author: alliswell
Status: DRAFT 
Type: Upgrade
Description: 支持WASM合约，同时优化关于节点错过出块期被处罚的策略
Created: 2020-03-30
---

# PIP-3：PlatON版本升级(0.11.0)-支持WASM合约与处罚策略优化

## 升级目的

1. 支持WASM合约
2. 对零出块行为处罚机制做优化
3. 修复了一些测试网发现的问题

## 升级内容

### 支持WASM合约

WebAssembly（简称WASM）是一种为栈式虚拟机设计的二进制指令集。WASM具有运行高效、内存安全、无未定义行为和平台独立等特点，经过了编译器和标准化团队多年耕耘，目前已经有了成熟的社区。在区块链领域，越来越多开发者倾向于基于WASM做DAPP开发，包括PlatON在内的多个公链项目也开始支持WASM。

PlatON目前已经支持：
- 编译，部署，调用WASM合约
- WASM合约升级，销毁
- 提供Java、Javascript sdk调用wasm合约
- platon-truffle支持wasm合约
- 支持权限模型
- 存储结构增加封装Array, Map, MultiIndex

### 节点零出块处罚措施改进

#### 概述

为了让更多诚实节点能公平公正的参与到PlatON网络建设中来，解除节点由于非主观原因而被轻易处罚的顾虑。同时为了整体提升PlatON网络的健壮性和安全性，充分保障正常节点不会因为网络抖动、节点升级等因素受到处罚。另一方面，充分发挥PlatON治理机制的优越性，让更多节点一起充分参与和讨论，在合理性和安全性之间寻求一个平衡点。

PoS类共识协议中，处罚是防止节点作恶，维护系统安全的必要手段。PlatON的PPoS协议中，针对零出块的节点进行处罚主要防止没有物理设备的虚假节点、恶意节点、不在线节点、配置太低的节点被选为验证节点后不生产和验证区块，直接影响整个网络的性能和活性。

PlatON现有的PPoS协议中，零出块行为的判断规则为在某个共识周期中被当选为验证节点但是没有生产任何有效的区块，零出块的行为的处罚策略为强制节点解除质押，质押金将被锁定一定的结算周期。

近期根据测试网的部分节点反馈，节点由于升级操作时间稍长或网络抖动等原因导致不能及时出块，从而被处罚，而且多数节点认为PlatON当前的处罚策略过于严厉，不利于节点参与网络治理。实际上零出块处罚实际要考虑的是安全性和容错性的权衡，现在是偏向安全性，目前我们以判断不在线的规则的确可能太严格，可能会误伤诚实节点。

为加强PlatON网络的容错性，避免诚实节点轻易被处罚，综合各个节点的意见，提议对当前处罚策略做出调整优化。

任何处罚措施都需要两个步骤：处罚行为判断和处罚执行措施。因此优化方向也可以从这两方面考虑：

- 放宽判断条件

  适当放宽零出块判断的条件，可以降低甚至消除短期升级或环境抖动的影响。比较直接的方案是根据更长的时间段的表现来判断，而不是根据短短几分钟的共识周期判断。但是恶意节点存在更长的无成本攻击时间，再考虑到虚假节点搭便车无成本获取更多收益的行为，这个时间段的长度应该不超过一个结算周期，因为质押成为节点并获得Staking收益需要一个结算周期的时间。

- 降低惩罚力度

  惩罚措施直接确定节点的成本，包括间接的收益损失和直接的质押金损失。这个成本也直接衡量了系统的安全性，也即是恶意节点的攻击成本。从安全性上看，惩罚力度越大越好。处罚措施可以分为三类：
  
  1）剥夺一段时间的被选取权
  
  对于节点来说，这种成本最低，只是一段时间的收益损失，另外一部分委托人基于利益的考虑也会更换委托节点，委托人的损失也是潜在的成本。对于诚实节点来说会是比较能接受的方案，操作上也比较方便。
  
  这个时间限制需要比强制解除质押的冻结时间短，否则跟强制解除质押没区别。所以这种方案实际上进一步降低了恶意节点的攻击成本，虚假节点搭便车的行为也不能得到很好的限制。
  
  2）扣除部分质押金
  
  本金的损失对节点来说有直接的成本感受，扣除多少也是需要仔细衡量的，需要在不影响诚实节点的参与积极性和有效处罚恶意节点中间做权衡。
  
  3）强制解除质押
  
  直接强制解除质押处罚措施，对于诚实节点来说要花相当长的时间才能重新参与到共识，特别是需要重新获得LAT持有者的委托。这个方案的成本在于间接的长时间不能参与共识导致的收益损失，但是从安全性角度来看是更好地增加了恶意节点的时间成本。
  
  

综合考虑，本次优化方案考虑以下方案：

1. 适当放宽判断条件，提高对诚实节点短期不稳定因素的容错性，适当降低诚实节点参与共识的成本，提高可操作性。
2. 保持强制解除质押的惩罚措施，以及扣除部分质押金（目前为0）。在第一个优化错误降低安全性的同时，作为平衡，保持更高的攻击成本。

#### 现有的零出块处罚的处理逻辑

- 每个共识周期中每出一个区块，系统根据出块节点的ID记录该节点的出块数。
- 下一个共识轮的固定块高第230个区块开始执行前对上一个共识轮每个节点的出块数做统计。
- 判断处罚条件：出块数小于一定数值（目前数值为1），则直接对该节点进行处罚。
- 处罚方式为：a.扣除一定比例的质押金（目前比例为0%） b.强制解质押该节点。

#### 提议调整处理逻辑

- 增加以下2个治理参数：
  1. 零出块最大容忍的共识周期数E，参数治理的范围为[N,43]，初始值为15
  2. 在最大容忍周期数内连续零出块的次数N，参数可治理范围为[1,E]，初始值为3
  
- 每一个共识轮的固定块高第230个区块开始执行前执行以下逻辑：
   1. 对上一个共识周期中每个验证人是否生产区块做判断。
   2. 如果有验证人节点未生产出块，则将节点行为记录或更新到一个观察列表中。
   3. 遍历观察列表中的每一个节点，当达到以下条件时对该节点进行处罚：
      A. 该验证节点首次出现零出块（即节点当选为验证人，并且在一个共识周期内没有出过块）到上一个共识周期数已经达到E。
	    B. 该节点在E内当选为验证人的次数超过N并且在E内没有出过任何一个区块。
   4. 观察列表的更新原则为：
      A. 只要节点在上一个共识周期生产过区块，直接将改节点移除观察列表。
	    B. 观察列表中每个节点对应一个在E内首次零出块所发生的共识周期数F和一个零出块发生的bit标识B（bit长度为E）。
	    C. 如果节点在上个共识周期没有当选为验证人，每次比特标识位左移一位，右补0，当选且没有出块，左移一位右补1。
	    节点没有当选：
	
	|    |    |    |    |    |    | F  |    |
	|:-- |:-- |:-- |:-- |:-- |:-- |:-- |:-- |
	|    |    |    |    |    |    |  1 |  0 |
	
	​        节点当选且零出块：
	
	|    |    |    |    |    |   |  F  |    |
	|:-- |:-- |:-- |:-- |:-- |:-- |:-- |:-- |
	|    |    |    |    |    |    |  1 |  1 |
	
	  D. 如果节点未达到处罚条件且首次零出块所发生的共识周期数对应的标识位被移出，如果右边没有为1的标识位，则将该节点从观察列表中清除，如果右边还有为1的标识，则更新F。
	  E. 判断是否需要处罚的条件
	
	|  F  |    |    |    |    |   |    |    |
	|:-- |:-- |:-- |:-- |:-- |:-- |:-- |:-- |
	|  1  | x | x  | x  | x  |  x |  x |  x |
	以上标识位，处罚条件为：B的最左bit为1并且x中1的个数大于（N-1）

### 问题修复

本次升级同时修复了以下问题：

-  修复了fast同步中途退出后节点启动失败问题

   **问题**：一旦fast同步过程中断，节点重新启动将失败
   
   **解决方案**:
   在节点首次进行fast同步时，如果同步途中因某些原因进程退出，造成底层存储的数据不一致，节点再次启动时会失败（数据不一致导致无法继续运行）
   本次对fast同步机制做了修改，如果首次fast同步不成功，后面再次启动节点时需要重新进行fast同步。
   
-  修复了频繁调用GetTransactionCount接口导致节点内存溢出问题

   **问题**：在链停止出块的前提下，频繁调用GetTransactionCount接口会导致节点内存不断增长，节点最终会因内存溢出而终止
   
   **解决方案**:
   此问题时RPC接口查询链上数据时父区块和子区块存在交叉引用，导致每次申请的内存没有办法回收，修复方案为对RPC接口做特殊处理，查询执行完直接解除引用
   
-  修复了不能向内置合约转账的问题

   **问题**：在测试网测试发现，不能直接向内置合约中转账
   
   **解决方案**:
   由于之前的版本对内置合约地址做了特殊处理，判断了data字段不能为空，所以直接转账会失败，本次通过升级提案对这个错误做了修复，可以直接转账到内置合约
   
-  修复了节点view差距很大时view同步慢的问题

   **问题**：3月9号链停止出块，11号升级恢复时发现节点间view差距较大，view同步太慢导致较长时间后链才恢复出块
   
   **解决方案**:
   判断如果当前节点和邻居节点view差距超过2时不再等超时，而是直接同步下一个view
   
-  修复了测试网节点同步时出现vrf invalidate问题

   **问题**：节点在同步偶尔会出现vrf invalidate问题，会导致节点同步停止，块高不会继续增长
   
   **解决方案**:
   此问题是由于CBFT引擎在出块时的时间过长导致，当前节点会根据时间超时启动再次出块，但由于上一个块还没出完，导致该节点双出，最终导致vrf校验失败，
   本次修改出块机制，出过一次当前高度的块将不会再次出同一高度的区块。
   
-  偶现BAD BLOCK问题

   **问题**：在存在EVM合约调用的交易中，个别节点执行区块出现BAD BLOCK
   
   **解决方案**:
   此问题由于PlatON存储优化设计中相同value被多个key引用导致，当前版本的修复方案是对value的引用做计数，当计数为0时才会删除。

## 版本信息

本次升级的版本号为：0.11.0
Commit-ID: 03a3e7dca51a03dd3290fa0a087cf884401ed871






